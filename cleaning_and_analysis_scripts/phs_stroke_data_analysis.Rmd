---
title: "PHS Stroke Data Analysis Project"
output:
  html_document:
    toc: yes
    toc_float: true
    toc_depth: '2'
    highlight: tango
    df_print: paged
---

## Assumptions made during cleaning

For activity data the diagnosis column "Cerebrovascular disease" covers everything and is essentially the "All" category. There were originally 3 sub-categories but these didn't add up to the total value under "Cerebrovascular disease". This is because there are some other diagnosis (with ICD codes I62, I65, I66-69) which fall outwith these sub-categories. For this reason a 4th sub-category was created called "Other CVD". 

For the mortality data, "TIAs and related syndromes" are included in the "Cerebrovascular disease" category and not separated out. 

There were a lot of missing values for Orkney, Shetland and Western Isles due to confidentiality. These were converted to zeros. EXPLAIN WHY

## Assumptions made during analysis

To determine which diagnosis is most common the number of diagnosis and number of deaths values were used, rather than the crude rates or easr. It was felt it was more important to know the actual number than a number adjusted for 100,000 of population (crude rate) or age adjusted (easr).


```{r}
library(tidyverse)
library(here)
library(sf)
library(leaflet)
library(htmlwidgets)
```

```{r}
source(here("theme_palette_etc/plot_theme.R"))
source(here("theme_palette_etc/palette.R"))
```

```{r}
activity_hb <- read_csv(here("clean_data/activity_hb.csv"))

mortality_hb <- read_csv(here("clean_data/mortality_hb.csv"))
```

## Q1 Most common stroke diagnosis?

There are two datasets which need analysed to answer this questions - the activity dataset which details the number of discharges and the mortality which details the number of deaths. It should be noted that one patient could have more than one discharge.

The unadultered values are used for this analysis as we are looking for the most common stroke diagnosis.

```{r}
activity_hb %>% 
# filter so we only have most recent 10 years
  filter(!financial_year %in% c("2009/10", "2010/11", "2011/12")) %>% 
# filter so we have all Scotland, ages, sex and admission types but not the CVD 
# total in diagnosis variable.
    filter(hbr == "S92000003" &
          age == "All" &
          sex == "All" &
          admission_type == "All" &
          diagnosis != "Cerebrovascular Disease") %>% 
# group by diagnosis and then take the mean over the 10 year period
    group_by(diagnosis) %>% 
  summarise(mean_num_discharges = mean(number_of_discharges)) %>% 
  mutate(diagnosis = fct_reorder(diagnosis, mean_num_discharges)) %>% 
  ggplot(aes(diagnosis, mean_num_discharges)) +
  geom_col(fill = c("#6d95bf", "#999999", "#9e8fcb", "#f084b6")) +
  theme_fc() +
  labs(title = "Discharges by Cerebrovascular Disease Diagnosis",
       subtitle = "10 year average", 
       y = "Annual Number of Discharges",
       x = "CVD Diagnosis") +
  coord_flip() +
  # code to wrap text so it goes over two lines
  scale_x_discrete(labels = function(x) str_wrap(x, width = 10)) 

activity_hb %>% 
  filter(!financial_year %in% c("2009/10", "2010/11", "2011/12")) %>% 
  filter(hbr == "S92000003" &
          age == "All" &
          sex == "All" &
          admission_type == "All" &
          diagnosis != "Cerebrovascular Disease") %>% 
  group_by(diagnosis) %>% 
  summarise(mean_crude_rate = mean(crude_rate)) %>% 
  mutate(diagnosis = fct_reorder(diagnosis, mean_crude_rate)) %>% 
  ggplot(aes(diagnosis, mean_crude_rate)) +
  geom_col(fill = c("#6d95bf", "#999999", "#9e8fcb", "#f084b6")) +
  theme_fc() +
  labs(title = "Discharges by Cerebrovascular Disease Diagnosis",
       subtitle = "10 year average", 
       y = "Mean Crude Rate",
       x = "CVD Diagnosis") +
  coord_flip() +
  # code to wrap text so it goes over two lines
  scale_x_discrete(labels = function(x) str_wrap(x, width = 10)) 

activity_hb %>% 
 filter(!financial_year %in% c("2009/10", "2010/11", "2011/12")) %>% 
  filter(hbr == "S92000003" &
          age == "All" &
          sex == "All" &
          admission_type == "All" &
          diagnosis != "Cerebrovascular Disease") %>% 
  group_by(diagnosis) %>% 
  summarise(mean_easr = mean(easr)) %>% 
  mutate(diagnosis = fct_reorder(diagnosis, mean_easr)) %>% 
  ggplot(aes(diagnosis, mean_easr)) +
  geom_col(fill = c("#6d95bf", "#999999", "#9e8fcb", "#f084b6")) +
  theme_fc() +
  labs(title = "Discharges by Cerebrovascular Disease Diagnosis",
       subtitle = "10 year average", 
       y = "EASR",
       x = "CVD Diagnosis") +
  coord_flip() +
  # code to wrap text so it goes over two lines
  scale_x_discrete(labels = function(x) str_wrap(x, width = 10)) 
```

Stroke is by far the most common diagnosis for patients who are discharged. 



```{r}
mortality_hb %>% 
  filter(year >= 2012) %>% 
  filter(hbr == "S92000003" &
          age == "All" &
          sex == "All" &
          diagnosis != "Cerebrovascular Disease") %>% 
  group_by(diagnosis) %>% 
  summarise(mean_num_deaths = mean(number_of_deaths)) %>% 
  mutate(diagnosis = fct_reorder(diagnosis, mean_num_deaths)) %>% 
  ggplot(aes(diagnosis, mean_num_deaths)) +
  geom_col(fill = c("#6d95bf", "#999999", "#9e8fcb")) +
  theme_fc() +
  labs(title = "Cerebrovascular Disease Mortality",
       subtitle = "10 year average", 
       y = "Annual Number of Deaths",
       x = "CVD Diagnosis") +
  coord_flip() +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 10)) 
```


For the patients that die, stroke is also the most common diagnosis but now the "Other CVD" category is much higher than for patients that are discharged. 

It is not easy to compare the death and discharge figures as they cover different time periods. Discharges are financial year and deaths are calendar year. 

Incidence data was sources from excel files related to the PHS Stroke report but these only subcategorised cerebrovascular disease and stroke.

## Q2 Demographics?

### Age

```{r, message = FALSE, warning = FALSE}
activity_hb %>% 
  mutate(diagnosis = factor(diagnosis, levels = c("Stroke", 
                                                  "Subarachnoid Haemorrhage",
                                                  "Other CVD",
                                                  "TIAs and related syndromes"
                                                  ))) %>% 
   filter(!financial_year %in% c("2009/10", "2010/11", "2011/12")) %>% 
  filter(hbr == "S92000003",
         sex == "All",
         admission_type == "All",
         !age %in% c("All", "under 75"), 
         diagnosis != "Cerebrovascular Disease") %>%
# the group_by and summarise were inserted to get rid of horizontal white lines on columns in plot
    group_by(age, diagnosis) %>% 
  summarise(mean_easr = mean(easr)) %>% 
  ggplot(aes(age, mean_easr)) +
  geom_col(aes(fill = diagnosis)) +
  facet_wrap(~diagnosis, scales = "free_y") +
  scale_fill_manual(values = c("#999999", "#9e8fcb", "#6d95bf", "#f084b6")) +
  theme_fc() + 
  theme(legend.position = "none",
        # changes font size of faceted plot titles. 
        strip.text = element_text(size = 14, colour = "grey30")) +
  labs(title = "Number of Discharges by Age and CVD Type (EASR)",
       subtitle = "10 year average")
```

### Sex

```{r, warning = FALSE, message = FALSE}
activity_sex_diagnosis <- activity_hb %>% 
  mutate(diagnosis = factor(diagnosis, levels = c("Stroke", "Subarachnoid Haemorrhage",
       "Other CVD",  "TIAs and related syndromes"))) %>% 
     filter(!financial_year %in% c("2009/10", "2010/11", "2011/12")) %>% 
  filter(hbr == "S92000003",
         sex != "All",
         admission_type == "All",
         age == "All", 
         diagnosis != "Cerebrovascular Disease") %>%
# the group_by and summarise were inserted to get rid of horizontal white lines on columns in plot
  group_by(sex, diagnosis) %>% 
  summarise(mean_discharges = mean(number_of_discharges),
            mean_crude_rate = mean(crude_rate),
            mean_easr = mean(easr))
  
  
  ggplot(activity_sex_diagnosis, aes(sex, mean_discharges)) +
  geom_col(aes(fill = sex)) +
  facet_wrap(~diagnosis, scales = "free_y") +
  scale_fill_manual(values = c("#999999", "#6d95bf")) +
  theme_fc() + 
  theme(legend.position = "none",
        # changes font size of faceted plot titles. 
        strip.text = element_text(size = 14, colour = "grey30")) +
    labs(title = "Number of Discharges by Sex and CVD Type",
       subtitle = "10 year average")

  ggplot(activity_sex_diagnosis, aes(sex, mean_crude_rate)) +
  geom_col(aes(fill = sex)) +
  facet_wrap(~diagnosis, scales = "free_y") +
  scale_fill_manual(values = c("#999999", "#6d95bf")) +
  theme_fc() + 
  theme(legend.position = "none",
        # changes font size of faceted plot titles. 
        strip.text = element_text(size = 14, colour = "grey30"))


  ggplot(activity_sex_diagnosis, aes(sex, mean_easr)) +
  geom_col(aes(fill = sex)) +
  facet_wrap(~diagnosis, scales = "free_y") +
  scale_fill_manual(values = c("#999999", "#6d95bf")) +
  theme_fc() + 
  theme(legend.position = "none",
        # changes font size of faceted plot titles. 
        strip.text = element_text(size = 14, colour = "grey30")) +
    labs(title = "Number of Discharges by Sex and CVD Type (EASR)",
       subtitle = "10 year average")

```




## Q4 Mortality

### Mortality by year

```{r}
mortality_hb %>% 
  filter(hbr == "S92000003",
         sex == "All",
         age == "All", 
         diagnosis == "Cerebrovascular Disease") %>% 
  ggplot(aes(year, easr)) +
  geom_point() +
  theme_fc() #+
 # scale_y_continuous(limits = c(2000, 5000))
```





### Age

```{r}
mortality_hb %>% 
  mutate(diagnosis = factor(diagnosis, levels = c("Stroke", 
                                                  "Subarachnoid Haemorrhage",
                                                  "Other CVD"))) %>% 
  filter(year > 2012,
    hbr == "S92000003",
         sex == "All",
         !age %in% c("All", "under 75"), 
         diagnosis != "Cerebrovascular Disease") %>%
# the group_by and summarise were inserted to get rid of horizontal white lines on columns in plot
    group_by(age, diagnosis) %>% 
  summarise(mean_easr = mean(easr)) %>% 
  ggplot(aes(age, mean_easr)) +
  geom_col(aes(fill = diagnosis)) +
  facet_wrap(~diagnosis, scales = "free_y", nrow = 2) +
  scale_fill_manual(values = c("#999999", "#9e8fcb", "#6d95bf")) +
  theme_fc() + 
  theme(legend.position = "none",
        # changes font size of faceted plot titles. 
        strip.text = element_text(size = 14, colour = "grey30")) +
    labs(title = "Mortality by Age and CVD Type (EASR)",
       subtitle = "10 year average")


```

### Sex

```{r, warning = FALSE, message = FALSE}
mortality_sex_diagnosis <- mortality_hb %>% 
  mutate(diagnosis = factor(diagnosis, levels = c("Stroke", 
        "Subarachnoid Haemorrhage", "Other CVD"))) %>% 
  filter(year >2012) %>% 
  filter(hbr == "S92000003",
         sex != "All",
         age == "All", 
         diagnosis != "Cerebrovascular Disease") %>%
  group_by(sex, diagnosis) %>% 
  summarise(mean_deaths = mean(number_of_deaths),
            mean_crude_rate = mean(crude_rate),
            mean_easr = mean(easr))
  
  
  ggplot(mortality_sex_diagnosis, aes(sex, mean_deaths)) +
  geom_col(aes(fill = sex)) +
  facet_wrap(~diagnosis, scales = "free_y", nrow = 2) +
  scale_fill_manual(values = c("#999999", "#6d95bf")) +
  theme_fc() + 
  theme(legend.position = "none",
        # changes font size of faceted plot titles. 
        strip.text = element_text(size = 14, colour = "grey30")) +
    labs(title = "Mortality by Sex and CVD Type",
       subtitle = "10 year average")

  ggplot(mortality_sex_diagnosis, aes(sex, mean_crude_rate)) +
  geom_col(aes(fill = sex)) +
  facet_wrap(~diagnosis, scales = "free_y") +
  scale_fill_manual(values = c("#999999", "#6d95bf")) +
  theme_fc() + 
  theme(legend.position = "none",
        # changes font size of faceted plot titles. 
        strip.text = element_text(size = 14, colour = "grey30"))


  ggplot(mortality_sex_diagnosis, aes(sex, mean_easr)) +
  geom_col(aes(fill = sex)) +
  facet_wrap(~diagnosis, scales = "free_y", nrow = 2) +
  scale_fill_manual(values = c("#999999", "#6d95bf")) +
  theme_fc() + 
  theme(legend.position = "none",
        # changes font size of faceted plot titles. 
        strip.text = element_text(size = 14, colour = "grey30")) +
    labs(title = "Mortality by Sex and CVD Type (EASR)",
       subtitle = "10 year average")

```



## Q3 Health Board or Council

### Population by health board

```{r}
hb_population <- read_csv(here("raw_data/health_board_populations.csv"))
```

```{r}
hb_population %>% 
  mutate(hb_name = fct_reorder(hb_name, population)) %>% 
ggplot(aes(hb_name, population)) +
  geom_col() +
  coord_flip()
```



















### Leaflet

```{r}
# simplified shapefile created for group project
scot_hb_shapefile <- st_read(here::here("map_files/scot_hb_shapefile_simplified.shp"))
```


```{r}
health_board_totals <- activity_hb %>% 
  filter(hbr != "S92000003",
         sex == "All",
         admission_type == "All",
         age == "All", 
         diagnosis == "Cerebrovascular Disease",
         financial_year == "2021/22") %>% 
  select(-c("financial_year", "hbr", "admission_type", "age", "sex", "diagnosis")) %>% 
  mutate(hbr_name = recode(hbr_name, "Ayrshire & Arran" = "Ayrshire and Arran",
                           "Dumfries & Galloway" = "Dumfries and Galloway",
                           "Greater Glasgow & Clyde" = "Greater Glasgow and Clyde"))

sf_stroke_data <- left_join(scot_hb_shapefile, health_board_totals, by = c("HBName" = "hbr_name"))
```

```{r}
# Prepare the text for tooltips:
mytext <- paste(
    "Health Board: ", sf_stroke_data$HBName,"<br/>", 
    "EASR: ", sf_stroke_data$easr, "<br/>", 
    sep="") %>%
  lapply(htmltools::HTML)

# originally used colorQuantile but colorNumeric creates a continuous color range 
# for continuous input which is what we have. 
pal <- colorNumeric(
  palette = "Purples",
  domain = sf_stroke_data$easr)

hb_discharge_easr <- leaflet(sf_stroke_data) %>% 
  addTiles()  %>% 
  setView( lat=57, lng=-5 , zoom=6) %>%
  addPolygons(stroke = TRUE, 
              color = "black", 
              weight = 1,
              fillOpacity = 0.8, 
    #          smoothFactor = 0.5, 
    #          fillColor = ~colorQuantile("Purples", easr)(easr) ,
              fillColor = ~pal(easr),
    label = mytext,
    labelOptions = labelOptions( 
      style = list("font-weight" = "normal", padding = "3px 8px"), 
      textsize = "13px", 
      direction = "auto"))

hb_discharge_easr 

# save the widget in a html file 
saveWidget(hb_discharge_easr, here("map_files/hb_discharge_easr.html"))

# For fill colours
# http://www.sthda.com/english/wiki/colors-in-r
```