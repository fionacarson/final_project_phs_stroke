---
title: "Geospatial Analysis"
output:
  html_document:
    toc: yes
    toc_float: true
    toc_depth: '2'
    highlight: tango
    df_print: paged
---


```{r}
library(sf)
library(leaflet)
```


```{r}
activity_hb %>% 
  filter(hbr != "S92000003",
         sex == "All",
         admission_type == "All",
         age == "All", 
         diagnosis == "Cerebrovascular Disease") %>% 
  ggplot(aes(financial_year, crude_rate)) +
  geom_point() +
  facet_wrap(~hbr_name)
```


https://r-graph-gallery.com/183-choropleth-map-with-leaflet.html

```{r}
# Library
library(leaflet)

# Create a color palette for the map:
mypalette <- colorNumeric( palette="viridis", domain=world_spdf@data$POP2005, na.color="transparent")
mypalette(c(45,43))

# Basic choropleth with leaflet?
m <- leaflet(world_spdf) %>% 
  addTiles()  %>% 
  setView( lat=10, lng=0 , zoom=2) %>%
  addPolygons( fillColor = ~mypalette(POP2005), stroke=FALSE )

m

# save the widget in a html file if needed.
# library(htmlwidgets)
# saveWidget(m, file=paste0( getwd(), "/HtmlWidget/choroplethLeaflet1.html"))
```

In a choropleth map, each region has a color that represents the value of a numeric variable (population here).

It is a good practice to check the distribution of this variable to understand what kind of color scale should be used. Using a histogram is often a good option for that:

```{r}
# load ggplot2
library(ggplot2)

# Distribution of the population per country?
world_spdf@data %>% 
  ggplot( aes(x=as.numeric(POP2005))) + 
    geom_histogram(bins=20, fill='#69b3a2', color='white') +
    xlab("Population (M)") + 
    theme_bw()
```




```{r}
# Create a color palette with handmade bins.
library(RColorBrewer)
mybins <- c(0,10,20,50,100,500,Inf)
mypalette <- colorBin( palette="YlOrBr", domain=world_spdf@data$POP2005, na.color="transparent", bins=mybins)
 
# Prepare the text for tooltips:
mytext <- paste(
    "Country: ", world_spdf@data$NAME,"<br/>", 
    "Area: ", world_spdf@data$AREA, "<br/>", 
    "Population: ", round(world_spdf@data$POP2005, 2), 
    sep="") %>%
  lapply(htmltools::HTML)
 
# Final Map
leaflet(world_spdf) %>% 
  addTiles()  %>% 
  setView( lat=10, lng=0 , zoom=2) %>%
  addPolygons( 
    fillColor = ~mypalette(POP2005), 
    stroke=TRUE, 
    fillOpacity = 0.9, 
    color="white", 
    weight=0.3,
    label = mytext,
    labelOptions = labelOptions( 
      style = list("font-weight" = "normal", padding = "3px 8px"), 
      textsize = "13px", 
      direction = "auto"
    )
  ) %>%
  addLegend( pal=mypalette, values=~POP2005, opacity=0.9, title = "Population (M)", position = "bottomleft" )

m  
  
# save the widget in a html file if needed.
# library(htmlwidgets)
# saveWidget(m, file=paste0( getwd(), "/HtmlWidget/choroplethLeaflet5.html"))
```



```{r}
scot_hb_shapefile <- st_read(here::here("map_files/scot_hb_shapefile_simplified.shp"))

health_board_lat_lon <- read_csv(here::here("map_files/health_board_lat_lon.csv"))  


```

```{r}
# update this so it is stroke data

updated_shapefile <- scot_hb_shapefile %>% 
  mutate(population = c(1, 4, 7, 15, 2, 4, 6, 32, 8,5, 3, 9, 2,5))
```

```{r}
# Create a color palette for the map:
mypalette <- colorNumeric( palette="viridis", 
                           domain=updated_shapefile$population, 
                           na.color="transparent")

mypalette(c(45,43))
```


```{r}



leaflet(updated_shapefile) %>% 
  addTiles()  %>% 
#  setView( lat=10, lng=0 , zoom=2) %>%
  addPolygons( 
    fillColor = ~mypalette(POP2005), 
    stroke=TRUE, 
    fillOpacity = 0.9, 
    color="white", 
    weight=0.3,
    label = mytext,
    labelOptions = labelOptions( 
      style = list("font-weight" = "normal", padding = "3px 8px"), 
      textsize = "13px", 
      direction = "auto"
    )
  )
```



```{r}
# Prepare the text for tooltips:
mytext <- paste(
    "Country: ", updated_shapefile$HBName,"<br/>", 
    "Crude Rate: ", updated_shapefile$population, "<br/>", 
    "XXXX: ", "xxxxx", 
    sep="") %>%
  lapply(htmltools::HTML)


# Color by quantile
m <- leaflet(updated_shapefile) %>% 
  addTiles()  %>% 
#  setView( lat=10, lng=0 , zoom=2) %>%
  addPolygons(stroke = TRUE, 
               color = "black", # without this blue lines, with gives none??
              weight = 0.5,
              fillOpacity = 0.5, 
    #          smoothFactor = 0.5, 
              fillColor = ~colorQuantile("YlOrRd", population)(population) ,
    label = mytext
#    labelOptions = labelOptions( 
 #     style = list("font-weight" = "normal", padding = "3px 8px"), 
  #    textsize = "13px", 
   #   direction = "auto"
      
    )

# For fill colours
# http://www.sthda.com/english/wiki/colors-in-r

m
 


# save the widget in a html file if needed.
library(htmlwidgets)
saveWidget(m, here("map_files/choroplethLeaflet2.html"))
```








```{r}
  output$map <- renderLeaflet({
    
    data_to_map <- summary_tab_map_data %>% 
      filter(metric == input$map_data_to_display)
    
    leaflet(scot_hb_shapefile) %>% 
      # addTiles adds scotland map from OpenStreetMap  
      addTiles() %>% 
      # addPolygons adds health board shape from shapefile
      addPolygons(color = "black", weight = 1) %>% 
      # fit scotland onto map using fitBounds once we know the dimensions of the map
      fitBounds(lat1 = 55, lng1 = -7, lat2 = 61, lng2 = 0) %>% 
      addCircleMarkers(lng = health_board_lat_lon$Longitude, 
                       lat = health_board_lat_lon$Latitude,
                       radius = data_to_map$scaled_value,
                       color = "purple",
                       weight = 3,
                       opacity = 0.8,
                       label = health_board_lat_lon$HBName)
  }) 
  
  output$summary_table <- renderTable(summary_tab_table_data)
```

