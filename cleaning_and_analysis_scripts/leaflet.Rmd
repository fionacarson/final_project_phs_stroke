---
title: "Geospatial Analysis"
output:
  html_document:
    toc: yes
    toc_float: true
    toc_depth: '2'
    highlight: tango
    df_print: paged
---


```{r}
library(sf)
library(leaflet)
library(tidyverse)
library(htmlwidgets)
```

```{r}
activity_hb <- read_csv(here("clean_data/activity_hb.csv"))

# simplified shapefile created for group project
scot_hb_shapefile <- st_read(here::here("map_files/scot_hb_shapefile_simplified.shp"))
```


```{r}
health_board_totals <- activity_hb %>% 
  filter(hbr != "S92000003",
         sex == "All",
         admission_type == "All",
         age == "All", 
         diagnosis == "Cerebrovascular Disease",
         financial_year == "2021/22") %>% 
  select(-c("financial_year", "hbr", "admission_type", "age", "sex", "diagnosis")) %>% 
  mutate(hbr_name = recode(hbr_name, "Ayrshire & Arran" = "Ayrshire and Arran",
                           "Dumfries & Galloway" = "Dumfries and Galloway",
                           "Greater Glasgow & Clyde" = "Greater Glasgow and Clyde"))

sf_stroke_data <- left_join(scot_hb_shapefile, health_board_totals, by = c("HBName" = "hbr_name"))
```


https://r-graph-gallery.com/183-choropleth-map-with-leaflet.html

In a choropleth map, each region has a color that represents the value of a numeric variable (population here).

It is a good practice to check the distribution of this variable to understand what kind of color scale should be used. Using a histogram is often a good option for that:


```{r}
# Prepare the text for tooltips:
mytext <- paste(
    "Health Board: ", sf_stroke_data$HBName,"<br/>", 
    "EASR: ", sf_stroke_data$easr, "<br/>", 
    sep="") %>%
  lapply(htmltools::HTML)

# originally used colorQuantile but colorNumeric creates a continuous color range 
# for continous input which is what we have. 
pal <- colorNumeric(
  palette = "Purples",
  domain = sf_stroke_data$easr)

hb_discharge_easr <- leaflet(sf_stroke_data) %>% 
  addTiles()  %>% 
  setView( lat=57, lng=-5 , zoom=6) %>%
  addPolygons(stroke = TRUE, 
              color = "black", 
              weight = 1,
              fillOpacity = 0.8, 
    #          smoothFactor = 0.5, 
    #          fillColor = ~colorQuantile("Purples", easr)(easr) ,
              fillColor = ~pal(easr),
    label = mytext,
    labelOptions = labelOptions( 
      style = list("font-weight" = "normal", padding = "3px 8px"), 
      textsize = "13px", 
      direction = "auto"))

hb_discharge_easr 

# save the widget in a html file if needed.
saveWidget(hb_discharge_easr, here("map_files/hb_discharge_easr.html"))

# For fill colours
# http://www.sthda.com/english/wiki/colors-in-r
```








```{r}
  output$map <- renderLeaflet({
    
    data_to_map <- summary_tab_map_data %>% 
      filter(metric == input$map_data_to_display)
    
    leaflet(scot_hb_shapefile) %>% 
      # addTiles adds scotland map from OpenStreetMap  
      addTiles() %>% 
      # addPolygons adds health board shape from shapefile
      addPolygons(color = "black", weight = 1) %>% 
      # fit scotland onto map using fitBounds once we know the dimensions of the map
      fitBounds(lat1 = 55, lng1 = -7, lat2 = 61, lng2 = 0) %>% 
      addCircleMarkers(lng = health_board_lat_lon$Longitude, 
                       lat = health_board_lat_lon$Latitude,
                       radius = data_to_map$scaled_value,
                       color = "purple",
                       weight = 3,
                       opacity = 0.8,
                       label = health_board_lat_lon$HBName)
  }) 
  
  output$summary_table <- renderTable(summary_tab_table_data)
```

